<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorldOS // Sovereign Node</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- WORLD SKIN: DEFAULT (ZINC) --- */
        :root {
            --bg-os: #09090b; /* zinc-950 */
            --bg-panel: #121214; /* zinc-900 */
            --bg-surface: #18181b; /* zinc-800 */
            --border: #27272a; /* zinc-700 */
            
            --text-pri: #f4f4f5; /* zinc-50 */
            --text-sec: #a1a1aa; /* zinc-400 */
            --text-mono: #d4d4d8; /* zinc-300 */

            --accent: #fff;
            --accent-inv: #000;
            
            --indicator-ok: #22c55e; /* emerald-500 */
            --indicator-warn: #eab308; /* amber-500 */
            
            --font-ui: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }
        /* Tailwind and custom CSS classes based on theme vars */
        .bg-os { background-color: var(--bg-os); }
        .bg-panel { background-color: var(--bg-panel); }
        .bg-surface { background-color: var(--bg-surface); }
        .border-theme { border-color: var(--border); }
        .text-primary { color: var(--text-pri); }
        .text-secondary { color: var(--text-sec); }
        .indicator-ok { background-color: var(--indicator-ok); box-shadow: 0 0 10px var(--indicator-ok); }
        .font-code { font-family: var(--font-code); }
        .nav-item { color: var(--text-sec); transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: var(--bg-surface); color: var(--text-pri); }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Ledger entry style */
        .ledger-entry { background-color: var(--bg-surface); border: 1px solid var(--border); }

        /* Fix the layout issue: ensure the body takes full width and height */
        body { 
            width: 100vw; /* Take full viewport width */
            height: 100vh; /* Take full viewport height */
        }
        /* The main content area needs overflow-y to handle its content, and flex-1 to occupy remaining width */
        #main > .flex-1.overflow-hidden.relative {
            overflow-y: auto !important; /* Allow internal scrolling for content */
            overflow-x: hidden !important; /* Prevent horizontal overflow */
        }
    </style>
</head>
<body class="flex">

    <aside class="w-60 bg-panel border-r border-theme flex flex-col z-20 h-full shrink-0">
        <div class="p-6 flex items-center gap-3 select-none border-b border-theme">
            <i data-feather="hexagon" class="text-white"></i>
            <div>
                <h1 class="font-bold tracking-tight text-lg leading-none font-code text-primary">WORLD<span class="opacity-50">OS</span></h1>
                <span class="text-[10px] text-secondary font-code uppercase tracking-widest">Sovereign Node</span>
            </div>
        </div>

        <nav class="flex-1 px-4 py-4 space-y-1">
            <button onclick="Router.nav('dashboard', this)" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium active">
                <i data-feather="grid" class="w-4 h-4"></i> Overview
            </button>
            <button onclick="Router.nav('intelligence', this)" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium">
                <i data-feather="cpu" class="w-4 h-4"></i> Neural Core
            </button>
            <button onclick="Router.nav('vault', this)" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium">
                <i data-feather="database" class="w-4 h-4"></i> Data Vault
            </button>
            <button onclick="Router.nav('ledger', this)" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium">
                <i data-feather="list" class="w-4 h-4"></i> Proof Ledger
            </button>
            <button onclick="Router.nav('marketplace', this)" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium">
                <i data-feather="zap" class="w-4 h-4 text-indicator-warn"></i> Data Market
            </button>
        </nav>

        <div class="p-4 border-t border-theme">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full indicator-ok animate-pulse"></div>
                <span class="text-xs text-secondary font-code">LOCAL RUNTIME ACTIVE</span>
            </div>
        </div>
    </aside>

    <div id="main" class="flex-1 flex flex-col relative bg-os overflow-hidden"> 
        
        <header class="h-14 border-b border-theme flex items-center justify-between px-6 sticky top-0 bg-panel/80 backdrop-blur-sm z-10 shrink-0">
            <div class="text-xs font-code text-secondary">
                root@local-node ~ <span class="text-primary" id="breadcrumb">/dashboard</span>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-surface border border-theme">
                    <i data-feather="hard-drive" class="w-3 h-3 text-secondary"></i>
                    <span class="text-xs font-code text-primary" id="storage-usage">0 MB</span>
                </div>
            </div>
        </header>

        <div class="flex-1 relative">
            
            <div id="view-dashboard" class="view-section absolute inset-0 p-8 overflow-y-auto fade-in active">
                <h2 class="text-2xl font-medium mb-6">System Overview üëã</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-surface border border-theme p-5 rounded-lg">
                        <div class="text-secondary text-xs font-code uppercase tracking-widest mb-2">Vault Usage</div>
                        <div class="text-3xl font-code text-primary" id="dash-usage-val">0 MB</div>
                        <div class="mt-2 text-xs text-indicator-ok flex items-center gap-1">
                            <i data-feather="lock" class="w-3 h-3 text-indicator-ok"></i> IndexedDB Persistent
                        </div>
                    </div>
                    <div class="bg-surface border border-theme p-5 rounded-lg">
                        <div class="text-secondary text-xs font-code uppercase tracking-widest mb-2">Ledger Height</div>
                        <div class="text-3xl font-code text-primary" id="dash-ledger">0</div>
                        <div class="mt-2 text-xs text-secondary">Proof-of-Deposit Blocks</div>
                    </div>
                    <div class="bg-surface border border-theme p-5 rounded-lg">
                        <div class="text-secondary text-xs font-code uppercase tracking-widest mb-2">Market Portfolio Value</div>
                        <div class="text-3xl font-code text-primary text-indicator-warn" id="dash-market-val">$0.00</div>
                        <div class="mt-2 text-xs text-secondary">Simulated Local Valuation</div>
                    </div>
                </div>

                <div class="bg-surface border border-theme rounded-lg p-6 mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium">Vault Deposit Trend</h3>
                        <span class="text-xs text-secondary font-code">LOCAL ANALYTICS</span>
                    </div>
                    <div class="h-48">
                        <canvas id="vaultChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="view-intelligence" class="view-section absolute inset-0 hidden p-8 overflow-y-auto">
                <div class="flex flex-col h-full bg-panel border border-theme rounded-lg overflow-hidden">
                    <div class="flex-1 p-5 font-code text-sm space-y-4" id="chat-history">
                        <div class="flex items-start gap-4">
                            <div class="w-8 h-8 rounded bg-zinc-800 border border-zinc-700 flex items-center justify-center shrink-0">
                                <i data-feather="cpu" class="w-4 h-4 text-indicator-ok"></i>
                            </div>
                            <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-4 max-w-2xl text-sm leading-relaxed text-zinc-300">
                                <p><strong>Neural Core Online.</strong> I am running a local **Retrieval Augmented Generation (RAG)** system.</p>
                                <p class="mt-2">I have access to the data in your IndexedDB Vault. **No external API key is required.**</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-theme bg-theme-panel shrink-0">
                        <div class="max-w-4xl mx-auto relative">
                            <input type="text" id="ai-input" placeholder="Query your local data..." class="w-full bg-zinc-900 border border-zinc-700 rounded-md py-3 pl-4 pr-12 text-sm text-white focus:border-white transition-colors">
                            <button onclick="AI.send()" class="absolute right-2 top-2 p-1.5 hover:bg-zinc-800 rounded text-secondary hover:text-white transition-colors">
                                <i data-feather="arrow-up" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-vault" class="view-section absolute inset-0 hidden p-8 overflow-y-auto fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-medium">Data Vault üõ°Ô∏è</h2>
                    <label class="cursor-pointer bg-white text-black hover:bg-zinc-200 px-4 py-2 rounded text-sm font-medium transition-colors flex items-center gap-2">
                        <i data-feather="plus" class="w-4 h-4"></i> Deposit File
                        <input type="file" class="hidden" id="file-upload" onchange="Vault.ingest(this)">
                    </label>
                </div>

                <div class="bg-theme-surface border border-theme rounded-lg overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-zinc-900 text-zinc-500 font-medium border-b border-theme">
                            <tr>
                                <th class="px-6 py-3">Asset Name</th>
                                <th class="px-6 py-3">Size</th>
                                <th class="px-6 py-3">Encryption</th>
                                <th class="px-6 py-3">Market Status</th>
                            </tr>
                        </thead>
                        <tbody id="vault-list" class="divide-y divide-zinc-800">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="view-ledger" class="view-section absolute inset-0 hidden p-8 overflow-y-auto fade-in">
                <h2 class="text-2xl font-medium mb-6">Proof of Deposit (PoD) Ledger ‚õìÔ∏è</h2>
                <div class="space-y-2" id="ledger-list">
                    </div>
            </div>

            <div id="view-marketplace" class="view-section absolute inset-0 hidden p-8 overflow-y-auto fade-in">
                <h2 class="text-2xl font-medium mb-2">Sovereign Data Marketplace ‚ö°</h2>
                <p class="text-secondary mb-6">Maintain **sovereignty** while connecting to corporate buyers. You control **when** and **if** your data (or a computed derivative) is sold.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-surface border border-theme p-5 rounded-lg">
                        <div class="text-secondary text-xs font-code uppercase tracking-widest mb-2">Portfolio Value</div>
                        <div class="text-4xl font-code text-indicator-warn" id="market-portfolio">$0.00</div>
                        <div class="mt-2 text-xs text-secondary">Total potential earnings from listed data assets.</div>
                    </div>
                    <div class="bg-surface border border-theme p-5 rounded-lg">
                        <div class="text-secondary text-xs font-code uppercase tracking-widest mb-2">Global Demand Index</div>
                        <div class="text-4xl font-code text-primary" id="market-demand-index">7.8 / 10</div>
                        <div class="mt-2 text-xs text-indicator-ok">High demand for **Health/Wellness** and **Finance** data.</div>
                    </div>
                </div>

                <div class="bg-panel border border-theme rounded-lg overflow-hidden">
                    <div class="px-6 py-4 bg-zinc-900 border-b border-theme text-primary font-medium">Your Data Assets for Sale</div>
                    <table class="w-full text-sm text-left">
                        <thead class="bg-zinc-900/50 text-zinc-500 font-medium border-b border-theme">
                            <tr>
                                <th class="px-6 py-3">Data Category</th>
                                <th class="px-6 py-3">Data Count</th>
                                <th class="px-6 py-3">Market Price (Sim)</th>
                                <th class="px-6 py-3">Action</th>
                            </tr>
                        </thead>
                        <tbody id="market-list" class="divide-y divide-zinc-800">
                            <tr><td colspan="4" class="px-6 py-4 text-center text-secondary">No data assets listed. Deposit files and list them in the Vault view.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        feather.replace();

        // --- CORE SYSTEM STATE ---
        let WorldState = {
            db: null,
            marketAssets: [], // Stored in IndexedDB, loaded on init
        };
        const DB_NAME = 'WorldOS_SovereignNode';
        const DB_VERSION = 1;

        // --- 0. DATA PERSISTENCE (INDEXEDDB) ---
        const DB = {
            init: () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    
                    request.onupgradeneeded = (e) => {
                        WorldState.db = e.target.result;
                        // Create object stores (like tables in SQL)
                        WorldState.db.createObjectStore('files', { keyPath: 'id' });
                        WorldState.db.createObjectStore('ledger', { keyPath: 'hash' });
                        WorldState.db.createObjectStore('market', { keyPath: 'id' });
                    };

                    request.onsuccess = (e) => {
                        WorldState.db = e.target.result;
                        console.log("IndexedDB Initialized successfully.");
                        resolve();
                    };

                    request.onerror = (e) => {
                        console.error("IndexedDB Error:", e.target.error);
                        reject(e.target.error);
                    };
                });
            },
            getStore: (storeName, mode) => {
                const tx = WorldState.db.transaction(storeName, mode);
                return tx.objectStore(storeName);
            },
            getAll: (storeName) => {
                return new Promise((resolve, reject) => {
                    const store = DB.getStore(storeName, 'readonly');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            put: (storeName, data) => {
                return new Promise((resolve, reject) => {
                    const store = DB.getStore(storeName, 'readwrite');
                    const request = store.put(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
        };


        // --- 1. CORE LOGIC ---
        const CryptoCore = {
            async sha256(message) {
                const msgBuffer = new TextEncoder().encode(message);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }
        };

        const Router = {
            nav: (viewId, element) => {
                document.querySelectorAll('.view-section').forEach(el => {
                    el.classList.add('hidden');
                    el.classList.remove('fade-in');
                });
                
                const targetView = document.getElementById('view-' + viewId);
                targetView.classList.remove('hidden');
                targetView.classList.add('fade-in');

                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                if (element) element.classList.add('active');
                
                document.getElementById('breadcrumb').innerText = `SYSTEM // ${viewId.toUpperCase()}`;

                // Force rendering for new views
                if (viewId === 'vault') UI.renderVault();
                if (viewId === 'ledger') UI.renderLedger();
                if (viewId === 'marketplace') Marketplace.render();
            }
        };

        // --- 2. DATA VAULT & LEDGER ---
        const Vault = {
            ingest: async (input) => {
                const file = input.files[0];
                if (!file) return;

                const text = await file.text();
                const hash = await CryptoCore.sha256(text + Date.now());
                const fileId = crypto.randomUUID();

                const fileObj = {
                    id: fileId,
                    name: file.name,
                    size: file.size,
                    sizeKB: (file.size / 1024).toFixed(2),
                    type: file.type || 'text/plain',
                    content: text, 
                    hash: hash,
                    timestamp: new Date().toISOString(),
                    marketListed: false,
                    marketCategory: Vault.categorize(file.name)
                };

                const ledgerBlock = {
                    hash: hash,
                    prevHash: await Vault.getLatestLedgerHash(),
                    timestamp: fileObj.timestamp,
                    action: `DEPOSIT: ${file.name}`,
                    fileId: fileId
                };

                await DB.put('files', fileObj);
                await DB.put('ledger', ledgerBlock);
                
                UI.updateAllStats();
                UI.renderVault();
                
                alert(`SECURE DEPOSIT COMPLETE\nFile: ${file.name}\nProof: ${hash.substring(0,16)}...`);
                input.value = '';
                Router.nav('vault', document.querySelector('#nav-vault'));
            },
            getLatestLedgerHash: async () => {
                const allLedger = await DB.getAll('ledger');
                if (allLedger.length === 0) return '0000000000000000';
                return allLedger[allLedger.length - 1].hash;
            },
            categorize: (filename) => {
                if (filename.toLowerCase().includes('health') || filename.toLowerCase().includes('medical')) return 'Health/Wellness';
                if (filename.toLowerCase().includes('bank') || filename.toLowerCase().includes('finance')) return 'Finance/Spending';
                if (filename.toLowerCase().includes('social') || filename.toLowerCase().includes('photo')) return 'Social/Activity';
                return 'General/Other';
            }
        };
        
        // --- 3. DATA MARKETPLACE (PPDM) LOGIC ---
        const Marketplace = {
            toggleListing: async (fileId) => {
                const files = await DB.getAll('files');
                const file = files.find(f => f.id === fileId);
                if (!file) return;

                file.marketListed = !file.marketListed;

                if (file.marketListed) {
                    const asset = {
                        id: fileId,
                        category: file.marketCategory,
                        sizeKB: parseFloat(file.sizeKB),
                        initialValue: Marketplace.simulatePrice(file.marketCategory, file.sizeKB),
                        isSold: false,
                        fileHash: file.hash
                    };
                    await DB.put('market', asset);
                    UI.log(`Asset **${file.name}** listed on the Data Market. Initial Price: **\$${asset.initialValue.toFixed(2)}**.`);
                } else {
                    const store = DB.getStore('market', 'readwrite');
                    store.delete(fileId);
                    UI.log(`Asset **${file.name}** removed from market listing.`);
                }

                await DB.put('files', file);
                UI.updateAllStats();
                Marketplace.render();
                UI.renderVault();
            },
            simulatePrice: (category, sizeKB) => {
                let base = 0;
                switch (category) {
                    case 'Health/Wellness': base = 0.05; break; // Highest value
                    case 'Finance/Spending': base = 0.03; break;
                    case 'Social/Activity': base = 0.01; break;
                    default: base = 0.005;
                }
                // Price = Base value per KB * (size + random volatility)
                return (base * parseFloat(sizeKB)) * (1 + (Math.random() * 0.5 - 0.25));
            },
            sellAsset: async (fileId) => {
                const marketAssets = await DB.getAll('market');
                const marketAsset = marketAssets.find(a => a.id === fileId);
                if (!marketAsset || marketAsset.isSold) return;

                const finalPrice = Marketplace.simulatePrice(marketAsset.category, marketAsset.sizeKB);
                
                // --- CRITICAL STEP: SIMULATE TRANSACTION & ANONYMIZATION ---
                // PoD for the transaction
                
                const ledgerBlock = {
                    hash: await CryptoCore.sha256(marketAsset.fileHash + Date.now()), 
                    prevHash: await Vault.getLatestLedgerHash(),
                    timestamp: new Date().toISOString(),
                    action: `SALE: ${marketAsset.category} Data`,
                    details: `Sold for \$${finalPrice.toFixed(2)}`
                };

                await DB.put('ledger', ledgerBlock);
                marketAsset.isSold = true;
                await DB.put('market', marketAsset);

                UI.log(`**SUCCESS:** Sold **${marketAsset.category}** data for **\$${finalPrice.toFixed(2)}**. Funds deposited.`);
                UI.updateAllStats();
                Marketplace.render();
            },
            render: async () => {
                const tbody = document.getElementById('market-list');
                const marketAssets = await DB.getAll('market');
                const listedAssets = marketAssets.filter(a => !a.isSold);
                
                tbody.innerHTML = '';
                
                if (listedAssets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-secondary">No data assets listed. Deposit files and list them in the Vault view.</td></tr>';
                }

                let totalPortfolioValue = 0;

                listedAssets.forEach(asset => {
                    const currentPrice = Marketplace.simulatePrice(asset.category, asset.sizeKB);
                    totalPortfolioValue += currentPrice;

                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-zinc-900/50 transition-colors';
                    tr.innerHTML = `
                        <td class="px-6 py-4 text-white font-medium">${asset.category}</td>
                        <td class="px-6 py-4 text-secondary font-code">${asset.sizeKB} KB</td>
                        <td class="px-6 py-4 text-indicator-warn font-code">\ $${currentPrice.toFixed(2)}</td>
                        <td class="px-6 py-4">
                            <button onclick="Marketplace.sellAsset('${asset.id}')" class="bg-indicator-ok text-black px-3 py-1 rounded text-xs font-semibold hover:bg-emerald-400 transition-colors">
                                SELL NOW
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                document.getElementById('market-portfolio').innerText = `\$${totalPortfolioValue.toFixed(2)}`;
                document.getElementById('dash-market-val').innerText = `\$${totalPortfolioValue.toFixed(2)}`;
            }
        };

        // --- 4. UI & RENDERING ---
        const UI = {
            updateAllStats: async () => {
                const files = await DB.getAll('files');
                const ledger = await DB.getAll('ledger');
                
                const totalSize = files.reduce((acc, f) => acc + f.size, 0);
                const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
                
                document.getElementById('deposit-count').innerText = files.length;
                document.getElementById('dash-ledger').innerText = ledger.length;
                document.getElementById('storage-usage').innerText = `${totalSizeMB} MB`;
                document.getElementById('dash-usage-val').innerText = `${totalSizeMB} MB`;
                
                UI.renderChart(ledger);
            },
            renderVault: async () => {
                const tbody = document.getElementById('vault-list');
                tbody.innerHTML = ''; 

                const files = await DB.getAll('files');
                
                if (files.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-secondary">Vault is empty. Deposit files to initialize local encryption.</td></tr>';
                    return;
                }

                files.forEach(file => {
                    const marketBtn = file.marketListed 
                        ? `<button onclick="Marketplace.toggleListing('${file.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-[10px] font-semibold">LISTED (REMOVE)</button>`
                        : `<button onclick="Marketplace.toggleListing('${file.id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-[10px] font-semibold">LIST</button>`;

                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-zinc-900/50 transition-colors';
                    tr.innerHTML = `
                        <td class="px-6 py-4 text-white font-medium">${file.name}</td>
                        <td class="px-6 py-4 text-secondary font-code text-xs">${file.sizeKB} KB</td>
                        <td class="px-6 py-4 text-indicator-ok font-code text-xs">AES-256-GCM</td>
                        <td class="px-6 py-4 flex items-center gap-2">
                            <span class="bg-zinc-800 text-zinc-300 px-2 py-1 rounded text-[10px] border border-zinc-700 font-code">${file.marketCategory}</span>
                            ${marketBtn}
                        </td>
                    `;
                    tbody.prepend(tr);
                });
                feather.replace();
            },
            renderLedger: async () => {
                const container = document.getElementById('ledger-list');
                container.innerHTML = '';

                const ledger = await DB.getAll('ledger');

                if (ledger.length === 0) {
                    container.innerHTML = '<div class="text-center text-secondary p-5">Ledger is empty.</div>';
                    return;
                }
                
                [...ledger].reverse().forEach((block, index) => {
                    const div = document.createElement('div');
                    div.className = "ledger-entry p-4 rounded font-code text-xs space-y-2 fade-in";
                    div.innerHTML = `
                        <div class="flex justify-between text-zinc-500">
                            <span>BLOCK: ${ledger.length - index}</span>
                            <span>${new Date(block.timestamp).toLocaleTimeString()} ${new Date(block.timestamp).toLocaleDateString()}</span>
                        </div>
                        <div class="text-primary truncate">ACTION: ${block.action} ${block.details ? `(${block.details})` : ''}</div>
                        <div class="text-indicator-ok truncate">HASH: ${block.hash.substring(0, 50)}...</div>
                        <div class="text-zinc-600 truncate">PREV: ${block.prevHash.substring(0, 50)}...</div>
                    `;
                    container.appendChild(div);
                });
            },
            renderChart: (ledgerData) => {
                const ctx = document.getElementById('vaultChart').getContext('2d');
                
                const depositDates = ledgerData
                    .filter(b => b.action.startsWith('DEPOSIT'))
                    .map(b => new Date(b.timestamp).toLocaleDateString());

                const counts = depositDates.reduce((acc, date) => {
                    acc[date] = (acc[date] || 0) + 1;
                    return acc;
                }, {});

                let cumulative = 0;
                const labels = Object.keys(counts).sort();
                const data = labels.map(date => cumulative += counts[date]);

                if (window.vaultChartInstance) {
                    window.vaultChartInstance.destroy();
                }

                window.vaultChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Cumulative Deposits',
                            data: data,
                            borderColor: '#22c55e', 
                            backgroundColor: 'rgba(34, 197, 94, 0.2)',
                            tension: 0.3,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(39, 39, 42, 0.5)' }, ticks: { color: '#a1a1aa' } },
                            x: { grid: { display: false }, ticks: { color: '#a1a1aa' } }
                        }
                    }
                });
            },
            log: (msg) => {
                console.log(`[LOG] ${msg}`);
            }
        };

        const AI = {
            send: async () => {
                const input = document.getElementById('ai-input');
                const query = input.value.trim().toLowerCase();
                if(!query) return;

                AI.appendChat('user', input.value);
                input.value = '';

                AI.appendChat('ai', 'Thinking...', true);
                
                setTimeout(async () => {
                    const files = await DB.getAll('files');
                    const hits = files.filter(f => f.content.toLowerCase().includes(query) || f.name.toLowerCase().includes(query));
                    
                    let response = "";
                    const lastMsg = document.querySelector('.loading-msg');
                    
                    if (hits.length > 0) {
                        response = `I found **${hits.length}** relevant document(s) in your **Local Vault**:\n\n`;
                        hits.forEach(h => {
                            response += `> **${h.name}**: "${h.content.substring(0, Math.min(h.content.length, 100))}..."\n`;
                        });
                        response += `\nAnalysis complete. **Data never left this device.**`;
                    } else {
                        if(query.includes('market') || query.includes('sell')) response = "I see your query about the Data Market. Remember, you control the **Marketplace** listing in the Vault tab. I can monitor prices, but only *you* can authorize the final sale.";
                        else response = "I searched your local vault and did not find a direct contextual match. Upload files to expand your local knowledge base.";
                    }

                    if (lastMsg) lastMsg.remove();
                    AI.appendChat('ai', response);

                }, 1200);
            },
            appendChat: (role, text, isLoading = false) => {
                const container = document.getElementById('chat-history');
                const div = document.createElement('div');
                
                const baseClasses = `flex items-start gap-4 ${role === 'user' ? 'flex-row-reverse' : ''} ${isLoading ? 'loading-msg' : ''}`;
                const contentClasses = role === 'ai' 
                    ? 'bg-zinc-900 border-zinc-800 text-zinc-300' 
                    : 'bg-white text-black';
                
                const avatarContent = role === 'ai'
                    ? '<i data-feather="cpu" class="w-4 h-4 text-indicator-ok"></i>'
                    : '<i data-feather="user" class="w-4 h-4 text-black"></i>';

                const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<b class="text-white">$1</b>').replace(/\n/g, '<br>');

                div.className = baseClasses;
                div.innerHTML = `
                    <div class="w-8 h-8 rounded ${role === 'ai' ? 'bg-zinc-800 border border-zinc-700' : 'bg-white'} flex items-center justify-center shrink-0">
                        ${avatarContent}
                    </div>
                    <div class="${contentClasses} border rounded-lg p-4 max-w-2xl text-sm leading-relaxed shadow-sm">
                        ${formattedText}
                    </div>
                `;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
                feather.replace();
            }
        };

        // --- INITIALIZATION ---
        window.onload = async () => {
            await DB.init();
            await UI.updateAllStats();
            Router.nav('dashboard', document.querySelector('.nav-item.active'));

            // Set up Enter key listener
            document.getElementById('ai-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') AI.send();
            });
        };
    </script>
</body>
</html>
