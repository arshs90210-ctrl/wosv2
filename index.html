<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorldOS // Sovereign Node</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* --- WORLD SKIN: DEFAULT (ZINC) --- */
        :root {
            --bg-os: #09090b; /* zinc-950 */
            --bg-panel: #121214; /* zinc-900 */
            --bg-surface: #18181b; /* zinc-800 */
            --border: #27272a; /* zinc-700 */
            
            --text-pri: #f4f4f5; /* zinc-50 */
            --text-sec: #a1a1aa; /* zinc-400 */
            --text-mono: #d4d4d8; /* zinc-300 */

            --accent: #fff;
            --accent-inv: #000;
            
            --indicator-ok: #22c55e; /* emerald-500 */
            --indicator-warn: #eab308; /* amber-500 */
            
            --font-ui: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        /* --- THEME: AMBER (CYBERPUNK) --- */
        [data-skin="amber"] {
            --bg-os: #0c0a00;
            --bg-panel: #141100;
            --bg-surface: #1f1a00;
            --border: #332b00;
            --text-pri: #ffcc00;
            --text-sec: #997a00;
            --text-mono: #ffcc00;
            --accent: #ffcc00;
            --accent-inv: #0c0a00;
            --indicator-ok: #ffcc00;
        }

        /* --- THEME: SLATE (CLEAN) --- */
        [data-skin="slate"] {
            --bg-os: #0f172a; /* slate-900 */
            --bg-panel: #1e293b; /* slate-800 */
            --bg-surface: #334155; /* slate-700 */
            --border: #475569; /* slate-600 */
            --text-pri: #f8fafc; /* slate-50 */
            --text-sec: #94a3b8; /* slate-400 */
            --accent: #38bdf8; /* sky-400 */
            --accent-inv: #0f172a;
        }

        /* --- CORE OS RESET & LAYOUT --- */
        * { box-sizing: border-box; outline: none; user-select: none; }
        body { 
            margin: 0; 
            background: var(--bg-os); 
            color: var(--text-pri); 
            font-family: var(--font-ui); 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            transition: background 0.3s ease; 
        }
        input, textarea { user-select: text; }

        /* Custom utility classes based on theme vars */
        .bg-os { background-color: var(--bg-os); }
        .bg-panel { background-color: var(--bg-panel); }
        .bg-surface { background-color: var(--bg-surface); }
        .border-theme { border-color: var(--border); }
        .text-primary { color: var(--text-pri); }
        .text-secondary { color: var(--text-sec); }
        .text-mono { color: var(--text-mono); }
        .text-accent { color: var(--accent); }
        .bg-accent { background-color: var(--accent); color: var(--accent-inv); }
        .indicator-ok { background-color: var(--indicator-ok); box-shadow: 0 0 10px var(--indicator-ok); }
        .font-code { font-family: var(--font-code); }
        
        /* Sidebar Item Styling (Combining Code 1 hover & Code 2 active) */
        .nav-item {
            color: var(--text-sec);
            transition: 0.2s;
        }
        .nav-item:hover, .nav-item.active { 
            background: var(--bg-surface); 
            color: var(--text-pri); 
        }

        /* Animations */
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.1); } 70% { box-shadow: 0 0 0 6px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Terminal / Chat specific styles */
        .msg.user { align-self: flex-end; background: var(--accent); color: var(--accent-inv); max-width: 80%; }
        .msg.system { align-self: flex-start; border: 1px solid var(--border); color: var(--text-sec); font-size: 0.8rem; max-width: 80%; }
        .msg.ai { align-self: flex-start; background: var(--bg-surface); border: 1px solid var(--border); color: var(--text-pri); max-width: 80%; }

    </style>
</head>
<body data-skin="default">

    <aside class="w-60 bg-panel border-r border-theme flex flex-col z-20">
        <div class="p-6 flex items-center gap-3 select-none border-b border-theme">
            <i data-feather="hexagon" class="text-accent"></i>
            <div>
                <h1 class="font-bold tracking-tight text-lg leading-none font-code text-primary">WORLD<span class="opacity-50">OS</span></h1>
                <span class="text-[10px] text-secondary font-code uppercase tracking-widest">Sovereign Node</span>
            </div>
        </div>

        <nav class="flex-1 px-4 py-4 space-y-1">
            <button onclick="Router.nav('dashboard', this)" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium active">
                <i data-feather="grid" class="w-4 h-4"></i> Overview
            </button>
            <button onclick="Router.nav('intelligence', this)" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium">
                <i data-feather="cpu" class="w-4 h-4"></i> Neural Core
            </button>
            <button onclick="Router.nav('vault', this)" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium">
                <i data-feather="database" class="w-4 h-4"></i> Data Vault
            </button>
            <button onclick="Router.nav('ledger', this)" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium">
                <i data-feather="list" class="w-4 h-4"></i> Proof Ledger
            </button>
        </nav>

        <div class="p-4 border-t border-theme">
            <button onclick="Router.nav('settings', this)" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium mb-4">
                <i data-feather="settings" class="w-4 h-4"></i> Config
            </button>
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full indicator-ok animate-pulse"></div>
                <span class="text-xs text-secondary font-code">LOCAL RUNTIME ACTIVE</span>
            </div>
        </div>
    </aside>

    <div id="main" class="flex-1 flex flex-col relative bg-os">
        
        <header class="h-14 border-b border-theme flex items-center justify-between px-6 sticky top-0 bg-panel/80 backdrop-blur-sm z-10">
            <div class="text-xs font-code text-secondary">
                root@local-node ~ <span class="text-primary" id="breadcrumb">/dashboard</span>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-surface border border-theme">
                    <i data-feather="hard-drive" class="w-3 h-3 text-secondary"></i>
                    <span class="text-xs font-code text-mono" id="dash-usage">0 MB</span>
                </div>
                <div class="w-7 h-7 rounded bg-gradient-to-br from-zinc-700 to-black border border-zinc-600"></div>
            </div>
        </header>

        <div class="flex-1 overflow-hidden relative">
            
            <div id="view-dashboard" class="view-section absolute inset-0 p-8 overflow-y-auto fade-in active">
                <h2 class="text-2xl font-medium mb-6">System Overview üëã</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-surface border border-theme p-5 rounded-lg">
                        <div class="text-secondary text-xs font-code uppercase tracking-widest mb-2">Vault Usage</div>
                        <div class="text-3xl font-code text-primary" id="dash-usage-val">0 MB</div>
                        <div class="mt-2 text-xs text-indicator-ok flex items-center gap-1">
                            <i data-feather="lock" class="w-3 h-3 text-indicator-ok"></i> Local-First / Encrypted
                        </div>
                    </div>
                    <div class="bg-surface border border-theme p-5 rounded-lg">
                        <div class="text-secondary text-xs font-code uppercase tracking-widest mb-2">Ledger Height</div>
                        <div class="text-3xl font-code text-primary" id="dash-ledger">0</div>
                        <div class="mt-2 text-xs text-secondary">Proof-of-Deposit Blocks</div>
                    </div>
                    <div class="bg-surface border border-theme p-5 rounded-lg">
                        <div class="text-secondary text-xs font-code uppercase tracking-widest mb-2">AI Status</div>
                        <div class="text-2xl font-medium text-primary mt-1">READY (SIM)</div>
                        <div class="mt-2 text-xs text-secondary">No API Key Req</div>
                    </div>
                </div>

                <div class="bg-surface border border-theme rounded-lg p-6 mb-8">
                    <h3 class="text-lg font-medium mb-3">Recent Activity</h3>
                    <div id="activity-log" class="font-code text-sm text-secondary space-y-1">
                        <div><span class="opacity-50">[SYSTEM]</span> Node initialized. Waiting for input...</div>
                    </div>
                </div>
            </div>

            <div id="view-intelligence" class="view-section absolute inset-0 hidden p-8">
                <div class="flex flex-col h-full bg-panel border border-theme rounded-lg overflow-hidden">
                    <div class="flex-1 p-5 overflow-y-auto font-code text-sm space-y-4" id="chat-history">
                        <div class="msg system p-3 rounded-lg">
                            WorldOS Neural Core v1.0 initialized.<br>
                            Running in **Sovereign Mode** (Local Simulation).<br>
                            No data leaves this device. No API keys required.
                        </div>
                        <div class="msg ai p-3 rounded-lg">
                            I am your local intelligence. I have access to your Vault and Ledger. How can I assist you with your data today?
                        </div>
                    </div>
                    <div class="p-4 bg-surface border-t border-theme flex gap-3">
                        <input type="text" class="flex-1 bg-transparent border border-theme rounded-md px-3 text-primary font-ui text-base" id="chat-input" placeholder="Query your world..." autocomplete="off">
                        <button class="bg-accent text-accent-inv px-5 py-2 rounded-md font-semibold text-sm" onclick="AI.send()">EXECUTE</button>
                    </div>
                </div>
            </div>

            <div id="view-vault" class="view-section absolute inset-0 hidden p-8 overflow-y-auto fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-medium">Data Vault üõ°Ô∏è</h1>
                    <button class="bg-accent text-accent-inv px-5 py-2 rounded-md font-semibold text-sm" onclick="document.getElementById('file-upload').click()">+ Deposit File</button>
                    <input type="file" id="file-upload" hidden onchange="Vault.ingest(this)">
                </div>
                
                <div class="bg-panel border border-theme rounded-lg overflow-hidden">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left bg-surface border-b border-theme text-secondary font-code uppercase text-xs">
                                <th class="p-4">FILENAME</th>
                                <th class="p-4">SIZE</th>
                                <th class="p-4">ENCRYPTION</th>
                                <th class="p-4">TYPE</th>
                            </tr>
                        </thead>
                        <tbody id="vault-list">
                            <tr><td colspan="4" class="text-center p-5 text-secondary">Vault is empty. Deposit your first file.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="view-ledger" class="view-section absolute inset-0 hidden p-8 overflow-y-auto fade-in">
                <h1 class="text-2xl font-medium mb-2">Proof-of-Deposit Ledger ‚õìÔ∏è</h1>
                <p class="text-secondary mb-6">Immutable record of all data ingress/egress. Hashed locally.</p>
                
                <div class="bg-panel border border-theme rounded-lg overflow-hidden">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left bg-surface border-b border-theme text-secondary font-code uppercase text-xs">
                                <th class="p-4">TIMESTAMP</th>
                                <th class="p-4">ACTION</th>
                                <th class="p-4">PROOF HASH (SHA-256)</th>
                            </tr>
                        </thead>
                        <tbody id="ledger-list">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="view-settings" class="view-section absolute inset-0 hidden p-8 overflow-y-auto fade-in">
                <h1 class="text-2xl font-medium mb-6">World Configuration ‚öôÔ∏è</h1>
                
                <div class="bg-surface border border-theme p-6 rounded-lg mb-6">
                    <h3 class="text-lg font-medium mb-4">Design Skin</h3>
                    <div class="flex gap-3">
                        <button class="bg-panel border border-theme text-primary px-4 py-2 rounded-md hover:border-primary transition-colors text-sm" onclick="UI.setSkin('default')">Zinc (Default)</button>
                        <button class="bg-panel border border-theme text-primary px-4 py-2 rounded-md hover:border-primary transition-colors text-sm" onclick="UI.setSkin('amber')">Amber (Cyber)</button>
                        <button class="bg-panel border border-theme text-primary px-4 py-2 rounded-md hover:border-primary transition-colors text-sm" onclick="UI.setSkin('slate')">Slate (Blue)</button>
                    </div>
                </div>

                <div class="bg-surface border border-theme p-6 rounded-lg">
                    <h3 class="text-lg font-medium mb-2">Portable World</h3>
                    <p class="text-secondary text-sm mb-4">Export your entire state (Vault + Ledger + Vectors) to a single encrypted file.</p>
                    <button class="bg-accent text-accent-inv px-5 py-2 rounded-md font-semibold text-sm" onclick="System.exportWorld()">Download .worldpack</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        feather.replace();

        // --- CORE SYSTEM STATE ---
        const State = {
            vault: [],
            ledger: [],
            skin: 'default',
        };

        // --- CRYPTO MODULE (REAL HASHING) ---
        const CryptoCore = {
            async sha256(message) {
                // Ensure message is a string for TextEncoder
                const msgString = typeof message === 'string' ? message : JSON.stringify(message);
                const msgBuffer = new TextEncoder().encode(msgString);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }
        };

        // --- ROUTER ---
        const Router = {
            nav: (viewId, element) => {
                document.querySelectorAll('.view-section').forEach(el => {
                    el.classList.remove('active');
                    el.classList.add('hidden');
                });
                
                const targetView = document.getElementById('view-' + viewId);
                targetView.classList.remove('hidden');
                targetView.classList.add('active', 'fade-in');

                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                if (element) {
                    element.classList.add('active');
                } else {
                    // Fallback to finding the correct nav item
                    document.getElementById(`nav-${viewId}`)?.classList.add('active');
                }
                
                document.getElementById('breadcrumb').innerText = `/${viewId}`;
            }
        };

        // --- UI CONTROLLER ---
        const UI = {
            setSkin: (skinName) => {
                document.body.setAttribute('data-skin', skinName);
                State.skin = skinName;
                UI.log(`System skin changed to: ${skinName}`);
            },
            log: (msg) => {
                const logEl = document.getElementById('activity-log');
                const time = new Date().toLocaleTimeString([], {hour12:false});
                const newLog = document.createElement('div');
                newLog.innerHTML = `<span class="opacity-50">[${time}]</span> ${msg}`;
                
                // Prepend new log item
                if (logEl.firstChild) {
                    logEl.insertBefore(newLog, logEl.firstChild);
                } else {
                    logEl.appendChild(newLog);
                }
            },
            renderVault: () => {
                const tbody = document.getElementById('vault-list');
                const totalSize = State.vault.reduce((a,b)=>a+b.size,0);
                const totalSizeKB = (totalSize/1024).toFixed(1);

                if(State.vault.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-5 text-secondary">Vault is empty. Deposit your first file.</td></tr>';
                    document.getElementById('dash-usage').innerText = `0 KB`;
                    document.getElementById('dash-usage-val').innerText = `0 MB`;
                    return;
                }
                
                tbody.innerHTML = State.vault.map(f => `
                    <tr>
                        <td class="p-4 font-medium">${f.name}</td>
                        <td class="p-4 font-code text-secondary">${(f.size/1024).toFixed(1)} KB</td>
                        <td class="p-4 text-indicator-ok font-medium">AES-256</td>
                        <td class="p-4 text-secondary">${f.type}</td>
                    </tr>
                `).join('');

                document.getElementById('dash-usage').innerText = `${totalSizeKB} KB`;
                document.getElementById('dash-usage-val').innerText = `${totalSizeKB} KB`;
            },
            renderLedger: () => {
                const tbody = document.getElementById('ledger-list');
                
                if (State.ledger.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center p-5 text-secondary">Ledger is currently empty.</td></tr>';
                } else {
                    tbody.innerHTML = State.ledger.map(l => `
                        <tr>
                            <td class="p-4 font-code text-secondary text-xs">${l.ts.substring(0, 10)} ${l.ts.substring(11, 19)}</td>
                            <td class="p-4 font-medium">${l.action}</td>
                            <td class="p-4 font-code text-secondary text-xs">${l.hash.substring(0, 30)}...</td>
                        </tr>
                    `).join('');
                }
                
                document.getElementById('dash-ledger').innerText = State.ledger.length;
            }
        };

        // --- VAULT LOGIC ---
        const Vault = {
            ingest: async (input) => {
                if(!input.files[0]) return;
                const file = input.files[0];
                
                // Simulate "Reading" and "Hashing" (Using file metadata as proxy content)
                const fakeContent = JSON.stringify({ name: file.name, size: file.size, lastModified: file.lastModified });
                const hash = await CryptoCore.sha256(fakeContent);
                
                const entry = {
                    name: file.name,
                    size: file.size,
                    type: file.type || 'unknown',
                    hash: hash,
                    added: Date.now()
                };

                State.vault.push(entry);
                
                // Update Ledger
                State.ledger.unshift({
                    ts: new Date().toISOString(),
                    action: `DEPOSIT: ${file.name}`,
                    hash: hash
                });

                UI.log(`Deposited: ${file.name} (Proof: ${hash.substring(0,8)}...)`);
                UI.renderVault();
                UI.renderLedger();
                input.value = null; // Clear input for next file
                Router.nav('vault'); // Switch to view result
            }
        };

        // --- AI LOGIC (LOCAL SIMULATION) ---
        const AI = {
            send: async () => {
                const inputEl = document.getElementById('chat-input');
                const text = inputEl.value.trim();
                if(!text) return;

                AI.appendMsg('user', text);
                inputEl.value = '';

                // Simulate "Thinking" delay
                AI.appendMsg('system', 'Reading Vault vectors... Generating response...');
                
                setTimeout(() => {
                    // Simple Rule-Based Simulation of a RAG System
                    let response;
                    const lowerText = text.toLowerCase();
                    const vaultCount = State.vault.length;
                    const ledgerCount = State.ledger.length;

                    if(lowerText.includes('hello') || lowerText.includes('hi')) {
                        response = "Systems online. I am ready to process your data locally.";
                    }
                    else if(lowerText.includes('vault') || lowerText.includes('files')) {
                        if(vaultCount === 0) {
                            response = "Your vault is currently empty. Upload files to begin building your local knowledge base.";
                        } else {
                            const names = State.vault.map(f => f.name).join(', ');
                            response = `I found **${vaultCount}** items in your secure vault. They include: **${names}**. I can analyze these if you wish.`;
                        }
                    }
                    else if(lowerText.includes('ledger') || lowerText.includes('proof')) {
                        response = `The ledger contains **${ledgerCount}** immutable entries. The last action was: **${State.ledger[0]?.action || 'None'}**.`;
                    }
                    else if(lowerText.includes('export') || lowerText.includes('backup')) {
                        response = "You can export your entire World state in the **Config** tab. This will generate a `.worldpack` file encrypted with your session key.";
                    }
                    else {
                        response = "I have logged that query. Since I am running in simulation mode, I can only track Vault, Ledger, and System status currently. In the full build, this would trigger a local Llama-3 inference.";
                    }

                    // Remove "thinking" msg and add real response
                    const history = document.getElementById('chat-history');
                    history.lastElementChild.remove();
                    AI.appendMsg('ai', response);
                }, 800);
            },
            appendMsg: (role, text) => {
                const history = document.getElementById('chat-history');
                const div = document.createElement('div');
                div.className = `msg ${role} p-3 rounded-lg`;
                div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); // Simple markdown parser
                history.appendChild(div);
                history.scrollTop = history.scrollHeight;
            }
        };

        // --- SYSTEM UTILITIES ---
        const System = {
            exportWorld: () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(State, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `world_backup_${Date.now()}.worldpack`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                UI.log("World exported to local disk.");
            },
            init: () => {
                // Initial render calls
                UI.renderVault();
                UI.renderLedger();
            }
        };
        
        // --- EVENT LISTENERS ---
        // Handle Enter key in chat
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') AI.send();
        });

        // Initialize the system
        System.init();

    </script>
</body>
</html>
